<!DOCTYPE html
<html>

<head>
<style>

/* Split the screen in half */
body {
  background-image: url("/home/grish/src/jai/attic-backend/img/attic-background.jpg");
  background-size: auto;
  background-repeat: repeat;
  background-position: right;
}

.input-wrapper {
  padding-right: 10px;
  padding-bottom: 10px;
}

</style>

<script type="module" src="https://md-block.verou.me/md-block.js"></script>

<script type="text/javascript">

  const baseUrl = "http://localhost:9980";

  async function loadAuthorsAndPosts() {
    const res = await fetch(`${baseUrl}/api/posts/by-author`);
    const authors = Array.from(await res.json());
    sessionStorage.setItem("authors", JSON.stringify(authors));

    sessionStorage.setItem("selectedAuthorIndex", 0);
    sessionStorage.setItem("selectedPostIndex", 0);
    getAuthors();
    getPosts();
  }

  function getAuthors() {
    const authors = JSON.parse(sessionStorage.getItem("authors"));
    const select = document.getElementById("select-authors");
    authors.forEach((author) => {
      const opt = document.createElement("option");
      opt.value = author.name;
      opt.innerHTML = author.name;
      select.appendChild(opt);
    });

    sessionStorage.setItem("authors", JSON.stringify(authors));
  }

  function getPosts() {
    const authors = JSON.parse(sessionStorage.getItem("authors"));

    const select = document.getElementById("select-posts");
    while (select.firstChild) {
      select.removeChild(select.lastChild);
    }

    const selectedAuthorIndex = sessionStorage.getItem("selectedAuthorIndex");
    let author = authors[selectedAuthorIndex];
    if (author == undefined) {
      return;
    };

    author.posts.forEach((post) => {
      const opt = document.createElement("option");
      opt.value = post.id;
      opt.innerHTML = post.title + " (" + post.date + ")";
      select.appendChild(opt);
    });

    setPostData(select.value);
  }

  function getSelectedPost() {
    const authors = Array.from(JSON.parse(sessionStorage.getItem("authors")));
    const selectedAuthorIndex = sessionStorage.getItem("selectedAuthorIndex");
    const selectedAuthor = authors[selectedAuthorIndex];

    const selectedPostIndex = sessionStorage.getItem("selectedPostIndex");
    const post = selectedAuthor.posts[selectedPostIndex];

    return post;
  }

  async function setPostData() {
    const post = getSelectedPost();

    document.getElementById("postTitle").value = post.title;
    document.getElementById("postAuthor").value = post.author;
    document.getElementById("postDate").value = post.date;

    await loadPostBody(post);
  }

  function storeSelectedAuthorIndex(authorName) {
    const authors = JSON.parse(sessionStorage.getItem("authors"));
    const index = authors.findIndex(a => a.name == authorName);
    sessionStorage.setItem("selectedAuthorIndex", index);
    sessionStorage.setItem("selectedPostIndex", 0);
  }

  function storeSelectedPostIndex(postID) {
    const authors = JSON.parse(sessionStorage.getItem("authors"));
    const selectedAuthorIndex = sessionStorage.getItem("selectedAuthorIndex");
    const author = authors[selectedAuthorIndex];
    const index = author.posts.findIndex(p => p.id == postID);
    sessionStorage.setItem("selectedPostIndex", index);
  }

  async function updatePostMetadata() {
    const post = getSelectedPost();
    const body = {
      title: document.getElementById("postTitle").value,
      author: document.getElementById("postAuthor").value,
      date: document.getElementById("postDate").value,
    };
    const res = await fetch(`${baseUrl}/api/posts/${post.id}/metadata`, {
      method: 'POST',
      body: JSON.stringify(body),
      headers: {
        'Content-Type': 'application/json',
      },
    });
  }

  async function loadPostBody(post) {
    document.getElementById("postBody").value = "";

    const res = await fetch(`${baseUrl}/api/posts/${post.id}/draft-body`);
    const data = await res.json();

    const markdown = data.data;
    document.getElementById("postBody").value = markdown;
  }

  async function saveDraftBody() {
    const post = getSelectedPost();
    const body = {
      data: document.getElementById("postBody").value,
    };
    const res = await fetch(`${baseUrl}/api/posts/${post.id}/draft-body`, {
      method: 'POST',
      body: JSON.stringify(body),
      headers: {
        'Content-Type': 'application/json',
      },
    });
  }

  loadAuthorsAndPosts();
</script>
</head>

<body>

<label for="select-authors">Author:</label>
<select name="Authors" id="select-authors" onchange="storeSelectedAuthorIndex(this.value); getPosts()">
</select>

<label for="select-posts">Post:</label>
<select name="Posts" id="select-posts" onchange="storeSelectedPostIndex(this.value); setPostData()">
</select>

<div class="input-wrapper">
<label for="postTitle">Title:</label>
<textarea id="postTitle" name="postTitle" style="float: center; width: 20%;" rows=1></textarea>
</div>

<div class="input-wrapper">
<label for="postAuthor">Author:</label>
<textarea id="postAuthor" name="postAuthor" style="float: center; width: 20%;" rows=1></textarea>
</div>

<div class="input-wrapper">
<label for="postDate">Date:</label>
<textarea id="postDate" name="postDate" style="float: center; width: 20%;" rows=1></textarea>
</div>

<button type="button" onclick="updatePostMetadata();">Update post metadata</button>

<div style="padding-top: 10px; padding-bottom: 20px; height: 90%;">
<textarea id="postBody" name="postBody" style="resize: false; width: 90%; height: 90%; margin: 0 auto; display: block;"></textarea>
</div>

<button type="button" onclick="saveDraftBody()">Save post draft</button>
<button type="button" style="float: right;" onclick="loadPreview()">Preview --></button>

</body>
</html>
